# 数据库基础设施与迁移使用指南

## 简介
为提升可维护性与部署灵活性，数据库与 Redis 的容器化管理统一迁移到 `infra/database`；数据库迁移与种子统一迁移到 `packages/db-schema`。本文给出标准使用流程与常见问题处理。

## 启动数据库（infra 栈）
```bash
docker compose -f infra/database/docker-compose.db.yml --env-file infra/database/.env.db up -d postgres redis
docker compose -f infra/database/docker-compose.db.yml ps
```

健康检查：
```bash
docker compose -f infra/database/docker-compose.db.yml exec -T postgres pg_isready -U postgres
```

端口冲突处理：
- 停止旧根栈：`docker compose down`
- 或修改 `infra/database/.env.db` 中 `DB_PORT_HOST`/`REDIS_PORT_HOST`（如改为 5434/6380）

## 初始化脚本
跨平台一键启动与初始化（创建应用用户与数据库、健康检查）：
```bash
# macOS
bash infra/database/scripts/init_mac.sh
# Linux
bash infra/database/scripts/init_linux.sh
# Windows
infra\\database\\scripts\\init_windows.bat
```

## 迁移与种子（db-schema 包）
迁移执行：
```bash
pnpm --filter @csisp/db-schema run migrate
# 或在包目录执行：
(cd packages/db-schema && pnpm run migrate)
```

种子执行：
```bash
pnpm --filter @csisp/db-schema run seed
# 或在包目录执行：
(cd packages/db-schema && pnpm run seed)
```

环境变量（推荐从 `infra/database/.env.db` 注入）：
- `DB_HOST`、`DB_PORT`、`DB_USER`、`DB_PASSWORD`、`DB_NAME`

说明：`db-schema` 内含 `/.sequelizerc` 与 `sequelize-config.cjs` 以兼容 `sequelize-cli` 的 CJS 加载；后端不再直接持有迁移与种子目录。

## 后端连接与运行
后端优先读取环境变量连接数据库，开发默认 `localhost:5433`（宿主机映射至容器 5432）。在容器网络内访问时使用服务名与容器端口（如 `DB_HOST=postgres`，`DB_PORT=5432`）。

## 故障排查
- 端口占用：释放旧容器或调整 `.env.db` 端口
- 健康检查失败：查看容器日志 `docker compose -f infra/database/docker-compose.db.yml logs postgres`
- 迁移失败：确保环境变量正确、数据库可达；必要时回滚并重试
- 重置环境：`docker compose -f infra/database/docker-compose.db.yml down -v` 后重新初始化
